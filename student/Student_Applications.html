<!DOCTYPE html>
<html>
<head>
  <title>My Applications</title>
  <link rel="stylesheet" href="Student_Internships.css">
</head>
<body>
  <div class="navbar">
    <a href="Student_Home.html">Dashboard</a>
    <a href="Student_Internships.html">Browse Internships</a>
    <a href="Student_Applications.html">My Applications</a>
    <a href="Student_Profile.html">Profile</a>
    <a href="Student_Logout.html">Logout</a>
  </div>
  <div class="main-content">
    <h2>My Applications</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Internship</th>
            <th>Company</th>
            <th>Location</th>
            <th>Status</th>
            <th>Date Applied</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="applicationsTableBody">
          <!-- Dynamic content will be loaded here -->
        </tbody>
      </table>
    </div>
    <div id="loadingMessage" style="text-align: center; padding: 20px;">
      Loading your applications...
    </div>
    <div id="noApplications" style="text-align: center; padding: 20px; display: none;">
      You haven't applied for any internships yet.
      <br><br>
      <a href="Student_Internships.html" style="color: #007bff; text-decoration: none;">Browse Available Internships</a>
    </div>
  </div>

  <script>
    let currentStudentId = null;

    // Get student data from session storage
    function getCurrentStudent() {
      const studentData = sessionStorage.getItem('studentData');
      if (studentData) {
        const student = JSON.parse(studentData);
        currentStudentId = student.id;
        return student;
      }
      // Redirect to login if no student data
      window.location.href = 'Student_Login.html';
      return null;
    }

    // Load student applications from database
    async function loadApplications() {
      if (!currentStudentId) return;
      
      try {
        const response = await fetch(`/api/student/${currentStudentId}/applications`);
        if (!response.ok) {
          throw new Error('Failed to fetch applications');
        }
        
        const applications = await response.json();
        // Filter out withdrawn applications and map company names properly
        const activeApplications = applications
          .filter(app => app.status !== 'withdrawn')
          .map(application => ({
            ...application,
            company: application.company_name || application.company || '[Company Name]'
          }));
        
        displayApplications(activeApplications);
      } catch (error) {
        console.error('Error loading applications:', error);
        document.getElementById('loadingMessage').textContent = 'Error loading applications. Please try again.';
      }
    }

    // Display applications in table
    function displayApplications(applications) {
      const tableBody = document.getElementById('applicationsTableBody');
      const loadingMessage = document.getElementById('loadingMessage');
      const noApplications = document.getElementById('noApplications');
      
      loadingMessage.style.display = 'none';
      
      if (applications.length === 0) {
        noApplications.style.display = 'block';
        return;
      }
      
      tableBody.innerHTML = '';
      
      applications.forEach(application => {
        const row = document.createElement('tr');
        const appliedDate = new Date(application.applied_date).toLocaleDateString();
        const statusClass = getStatusClass(application.status);
        
        row.innerHTML = `
          <td>${application.title}</td>
          <td>${application.company}</td>
          <td>${application.location}</td>
          <td><span class="status-badge ${statusClass}">${capitalizeFirst(application.status)}</span></td>
          <td>${appliedDate}</td>
          <td>
            ${getApplicationActionButton(application)}
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Get status class for styling
    function getStatusClass(status) {
      switch(status) {
        case 'pending': return 'status-active';
        case 'accepted': return 'status-success';
        case 'rejected': return 'status-closed';
        case 'withdrawn': return 'status-warning';
        default: return 'status-active';
      }
    }

    // Capitalize first letter
    function capitalizeFirst(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // Get appropriate action button for application
    function getApplicationActionButton(application) {
      if (application.status === 'pending') {
        return `<button class="action-btn btn-delete" onclick="withdrawApplication(${application.id})">Withdraw</button>`;
      } else {
        return '<button class="action-btn btn-delete" disabled>Withdraw</button>';
      }
    }

    // Withdraw application
    async function withdrawApplication(applicationId) {
      if (confirm('Are you sure you want to withdraw this application?')) {
        try {
          const response = await fetch(`/api/student/application/${applicationId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ studentId: currentStudentId })
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('Application withdrawn successfully!');
            loadApplications(); // Reload to update the list
          } else {
            alert(result.message || 'Failed to withdraw application.');
          }
        } catch (error) {
          console.error('Error withdrawing application:', error);
          alert('Failed to withdraw application. Please try again.');
        }
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      getCurrentStudent();
      loadApplications();
    });
  </script>
</body>
</html> 