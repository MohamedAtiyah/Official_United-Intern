<!DOCTYPE html>
<html>
<head>
  <title>Browse Internships</title>
  <link rel="stylesheet" href="Student_Internships.css">
</head>
<body>
  <div class="navbar">
    <a href="Student_Home.html">Dashboard</a>
    <a href="Student_Internships.html">Browse Internships</a>
    <a href="Student_Applications.html">My Applications</a>
    <a href="Student_Profile.html">Profile</a>
    <a href="Student_Logout.html">Logout</a>
  </div>
  <div class="main-content">
    <h2>Available Internships</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>Company</th>
            <th>Location</th>
            <th>Duration</th>
            <th>Type</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="internshipsTableBody">
          <!-- Dynamic content will be loaded here -->
        </tbody>
      </table>
    </div>
    <div id="loadingMessage" style="text-align: center; padding: 20px;">
      Loading internships...
    </div>
    <div id="noInternships" style="text-align: center; padding: 20px; display: none;">
      No internships available at the moment.
    </div>
  </div>

  <script>
    let currentStudentId = null;

    // Get student data from session storage
    function getCurrentStudent() {
      const studentData = sessionStorage.getItem('studentData');
      if (studentData) {
        const student = JSON.parse(studentData);
        currentStudentId = student.id;
        return student;
      }
      // Redirect to login if no student data
      window.location.href = 'Student_Login.html';
      return null;
    }

    // Load internships from database
    async function loadInternships() {
      try {
        const response = await fetch('/api/student/internships');
        if (!response.ok) {
          throw new Error('Failed to fetch internships');
        }
        
        const internships = await response.json();
        // Map company_name field to company for consistency
        const mappedInternships = internships.map(internship => ({
          ...internship,
          company: internship.company_name || internship.company || '[Company Name]'
        }));
        displayInternships(mappedInternships);
      } catch (error) {
        console.error('Error loading internships:', error);
        document.getElementById('loadingMessage').textContent = 'Error loading internships. Please try again.';
      }
    }

    // Display internships in table
    async function displayInternships(internships) {
      const tableBody = document.getElementById('internshipsTableBody');
      const loadingMessage = document.getElementById('loadingMessage');
      const noInternships = document.getElementById('noInternships');
      
      loadingMessage.style.display = 'none';
      
      if (internships.length === 0) {
        noInternships.style.display = 'block';
        return;
      }
      
      tableBody.innerHTML = '';
      
      for (const internship of internships) {
        // Check if student has already applied
        const applicationStatus = await checkApplicationStatus(internship.id);
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${internship.title}</td>
          <td>${internship.company}</td>
          <td>${internship.location}</td>
          <td>${internship.duration}</td>
          <td>${internship.type}</td>
          <td><span class="status-badge status-${internship.status.toLowerCase()}">${internship.status}</span></td>
          <td>
            ${getActionButton(internship, applicationStatus)}
          </td>
        `;
        tableBody.appendChild(row);
      }
    }

    // Check if student has applied for this internship
    async function checkApplicationStatus(internshipId) {
      if (!currentStudentId) return { hasApplied: false };
      
      try {
        const response = await fetch(`/api/student/${currentStudentId}/application-status/${internshipId}`);
        if (response.ok) {
          return await response.json();
        }
      } catch (error) {
        console.error('Error checking application status:', error);
      }
      return { hasApplied: false };
    }

    // Get appropriate action button based on internship status and application status
    function getActionButton(internship, applicationStatus) {
      if (applicationStatus.hasApplied) {
        const status = applicationStatus.status;
        if (status === 'pending') {
          return '<button class="action-btn btn-warning" disabled>Applied</button>';
        } else if (status === 'accepted') {
          return '<button class="action-btn btn-success" disabled>Accepted</button>';
        } else if (status === 'rejected') {
          return '<button class="action-btn btn-error" disabled>Rejected</button>';
        }
      }
      
      if (internship.status === 'Active') {
        return `<button class="action-btn btn-apply" onclick="applyForInternship(${internship.id})">Apply</button>`;
      } else {
        return '<button class="action-btn btn-apply" disabled>Closed</button>';
      }
    }

    // Apply for internship
    async function applyForInternship(internshipId) {
      if (!currentStudentId) {
        alert('Please log in to apply for internships.');
        return;
      }
      
      if (confirm('Are you sure you want to apply for this internship?')) {
        try {
          const response = await fetch('/api/student/apply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              studentId: currentStudentId,
              internshipId: internshipId
            })
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('Application submitted successfully!');
            loadInternships(); // Reload to update button states
          } else {
            alert(result.message || 'Failed to submit application.');
          }
        } catch (error) {
          console.error('Error applying for internship:', error);
          alert('Failed to submit application. Please try again.');
        }
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      getCurrentStudent();
      loadInternships();
    });
  </script>
</body>
</html> 